<% cred = FreeeCredential.first %>

<h3>認証設定</h3>

<% unless cred.present? %>
<p>
  Client ID / Secret を入力、保存してから認証を開始してください
</p>

<p>
  <label for="settings_client_id">Client ID</label>
  <input type="text" id="settings_client_id"
         name="settings[client_id]"
         value="<%= settings['client_id'] %>" />
</p>

<p>
  <label for="settings_client_secret">Client Secret</label>
  <input type="password" id="settings_client_secret"
         name="settings[client_secret]"
         value="<%= settings['client_secret'] %>" />
</p>

<p>
  <input type="submit" value="保存" class="button-small">
</p>

<hr>
<% end %>

<!-- ========================================================= -->
<!--  認証状態 -->
<!-- ========================================================= -->

<% if cred.present? %>
<%
  # freee API 接続確認（設定画面を開くたびに 1 回だけ実行）
  begin
    comps = FreeeApiClient.companies
    if comps.present?
      api_status  = :ok
      api_message = "#{comps.size} 件の事業所を取得"
    else
      api_status  = :empty
      api_message = "接続は成功したが、取得できる事業所がありません"
    end
  rescue => e
    api_status  = :error
    api_message = "freee API エラー: #{e.message}"
  end
%>
  <p><strong>認証状態：</strong> ✅ 認証済み</p>
  <p><strong>freee API 接続テスト：</strong>
    <% case api_status
       when :ok %>
      <span style="color: green;">● OK</span>（<%= api_message %>）
    <% when :empty %>
      <span style="color: orange;">● 接続 OK</span>（<%= api_message %>）
    <% when :error %>
      <span style="color: red;">● エラー</span>（<%= api_message %>）
    <% else %>
      <span>● 未確認</span>
    <% end %>
  </p>
  <p><strong>Access Token 有効期限：</strong><%= cred.expires_at %></p>
  <p>
    <%= link_to "認証解除する",
          "/redmine_freee/auth/reset",
          method: :post,
          data: { confirm: "認証を解除しますか？" } %>
  </p>
<% else %>
  <p><strong>認証状態：</strong> ❌ 未認証</p>
  <p>
    <%= link_to "▶ 認証を開始する", "/redmine_freee/auth/start" %>
  </p>
<% end %>

<hr>

<!-- ========================================================= -->
<!--  見積書（QUOTATION） -->
<!-- ========================================================= -->

<h3>📄 見積書定</h3>

<p>
  <label>
    <%= check_box_tag 'settings[sync_quotations]', '1',
          settings['sync_quotations'] == '1' %>
    見積書を同期する
  </label>
</p>

<p>
  見積書が <strong>送付済み (sent)</strong> の時のステータス：
  <%= select_tag 'settings[quotation_sent_status]',
        options_for_select(
          [["変更しない", 0]] + IssueStatus.all.map { |s| [s.name, s.id] },
          selected: settings['quotation_sent_status'].to_i
        )
  %>
  <label>見積書（送付済）のコメントテンプレート：</label><br>
  <textarea name="settings[quotation_sent_comment]" rows="3" style="width: 98%;"><%= settings['quotation_sent_comment'] %></textarea>
</p>

<p>
  見積書が <strong>未送付 (unsent)</strong> の時のステータス：
  <%= select_tag 'settings[quotation_unsent_status]',
        options_for_select(
          [["変更しない", 0]] + IssueStatus.all.map { |s| [s.name, s.id] },
          selected: settings['quotation_unsent_status'].to_i
        )
  %>
  <label>見積書（未送付）のコメントテンプレート：</label><br>
  <textarea name="settings[quotation_unsent_comment]" rows="3" style="width: 98%;"><%= settings['quotation_unsent_comment'] %></textarea>
</p>

<hr>

<!-- ========================================================= -->
<!--  請求書（INVOICE） -->
<!-- ========================================================= -->

<h3>🧾 請求書設定</h3>

<p>
  <label>
    <%= check_box_tag 'settings[sync_invoices]', '1',
          settings['sync_invoices'] == '1' %>
    請求書を同期する
  </label>
</p>

<p>
  請求書が <strong>送付済み (sent)</strong> の時のステータス：
  <%= select_tag 'settings[invoice_sent_status]',
        options_for_select(
          [["変更しない", 0]] + IssueStatus.all.map { |s| [s.name, s.id] },
          selected: settings['invoice_sent_status'].to_i
        )
  %>
  <label>請求書（送付済）のコメントテンプレート：</label><br>
  <textarea name="settings[invoice_sent_comment]" rows="3" style="width: 98%;"><%= settings['invoice_sent_comment'] %></textarea>
</p>

<p>
  請求書が <strong>未送付 (unsent)</strong> の時のステータス：
  <%= select_tag 'settings[invoice_unsent_status]',
        options_for_select(
          [["変更しない", 0]] + IssueStatus.all.map { |s| [s.name, s.id] },
          selected: settings['invoice_unsent_status'].to_i
        )
  %>
  <label>請求書（未送付）のコメントテンプレート：</label><br>
  <textarea name="settings[invoice_unsent_comment]" rows="3" style="width: 98%;"><%= settings['invoice_unsent_comment'] %></textarea>
</p>

<p>
  請求書が <strong>入金済み (settled)</strong> の時のステータス：
  <%= select_tag 'settings[invoice_paid_status]',
        options_for_select(
          [["変更しない", 0]] + IssueStatus.all.map { |s| [s.name, s.id] },
          selected: settings['invoice_paid_status'].to_i
        )
  %>
  <label>請求書（入金済み）のコメントテンプレート：</label><br>
  <textarea name="settings[invoice_paid_comment]" rows="3" style="width: 98%;"><%= settings['invoice_paid_comment'] %></textarea>
  請求書が <strong>入金待ち (unsettled)</strong> の時のステータス：
  <%= select_tag 'settings[invoice_unpaid_status]',
        options_for_select(
          [["変更しない", 0]] + IssueStatus.all.map { |s| [s.name, s.id] },
          selected: settings['invoice_unpaid_status'].to_i
        )
  %>
  <label>請求書（入金待ち）のコメントテンプレート：</label><br>
  <textarea name="settings[invoice_unpaid_comment]" rows="3" style="width: 98%;"><%= settings['invoice_unpaid_comment'] %></textarea>
</p>

<hr>

<p>
  <label for="settings_max_fetch_total">最新からの最大取得件数</label>
  <% options = [
    [100],
    [200],
    [300],
    [400],
    [500],
    ['無制限', 'unlimited']
  ] %>

  <%= select_tag(
        'settings[max_fetch_total]',
        options_for_select(options, settings['max_fetch_total'] || 20)
      ) %>
</p>

<p>
  無制限を使うと freee API 使用制限にかかることがあります
  <a href="https://developer.freee.co.jp/reference/iv/reference#api_rate_limit"
     target="_blank" rel="noopener">
    freee API レートリミットについて
  </a>
</p>

<hr>

<p>
  <label for="settings_user_id">更新時に使用する Redmine ユーザー</label>
  <%= select_tag 'settings[user_id]',
        options_from_collection_for_select(
          User.active.order(:login), :id, :login, settings['user_id']
        )
  %>
</p>

<p>
  このユーザーとして Issue のコメントおよびステータス更新が実行されます。
</p>
