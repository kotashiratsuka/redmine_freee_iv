<% creds = FreeeIvCredential.all %>
<% authed_count = creds.size %>

<h3>認証設定</h3>

<% if authed_count == 0 %>

  <p>Client ID / Secret を入力、保存してから認証を開始してください</p>

  <p>
    <label>Client ID</label>
    <input type="text" name="settings[client_id]" value="<%= settings['client_id'] %>" />
  </p>

  <p>
    <label>Client Secret</label>
    <input type="password" name="settings[client_secret]" value="<%= settings['client_secret'] %>" />
  </p>

  <p><input type="submit" value="保存" class="button-small"></p>

  <% if settings['client_id'].present? && settings['client_secret'].present? %>
    <p><%= link_to "▶ 認証を開始する", "/redmine_freee_iv/auth/start" %></p>
  <% end %>

<% else %>

  <%
    begin
      comps = FreeeApiClient.companies
      api_status  = :ok
      api_message = "#{comps.size} 件の事業所を取得しました"
    rescue => e
      comps = []
      api_status  = :error
      api_message = "APIエラー: #{e.message}"
    end

    creds_by_id = FreeeIvCredential.all.index_by(&:company_id)
  %>

  <%# ================================
     API成功 && comps=0 → token破損扱い
     ================================ %>
  <% if api_status == :ok && comps.size == 0 %>

    <p style="color:red; font-weight:bold;">
      事業所が取得できません。再認証が必要です。
    </p>

    <% if settings['client_id'].present? && settings['client_secret'].present? %>
      <p>
        <%= link_to "▶ 再認証する", "/redmine_freee_iv/auth/start" %>
      </p>
    <% end %>

    <p style="margin-top: 1em;">
      <strong>既存の認証情報：</strong>
    </p>

    <% creds.each do |cred| %>
      <p style="margin-left: 1em;">
        <strong>事業所 ID: <%= cred.company_id %></strong>：
        <span style="color: orange;">認証エラー</span>
        <%= link_to "認証解除",
              "/redmine_freee_iv/auth/revoke?company_id=#{cred.company_id}",
              method: :delete,
              data: { confirm: "この事業所の認証を解除しますか？" } %>
      </p>
    <% end %>

  <% elsif api_status == :error %>

    <p><strong>freee API 接続テスト：</strong>
      <span style="color: red;">● エラー</span>（<%= api_message %>）
    </p>

    <% if settings['client_id'].present? && settings['client_secret'].present? %>
      <p><%= link_to "▶ 再認証する", "/redmine_freee_iv/auth/start" %></p>
    <% end %>

    <p style="margin-top: 1em;">
      <strong>既存の認証情報：</strong>
    </p>

    <% creds.each do |cred| %>
      <p style="margin-left: 1em;">
        <strong>事業所 ID: <%= cred.company_id %></strong>：
        <span style="color: orange;">認証エラー</span>
        <%= link_to "認証解除",
              "/redmine_freee_iv/auth/revoke?company_id=#{cred.company_id}",
              method: :delete,
              data: { confirm: "この事業所の認証を解除しますか？" } %>
      </p>
    <% end %>

  <% else %>

    <p>
      <strong>認証済事業所数：</strong>
      <%= creds_by_id.size %> / <%= comps.size %>
    </p>

    <p><strong>freee API 接続テスト：</strong>
      <span style="color: green;">● OK</span>（<%= api_message %>）
    </p>

    <% comps.each do |c| %>
      <% cid = c["id"].to_s %>
      <p style="margin-left: 1em;">
        <strong><%= c["display_name"] %></strong>（ID: <%= cid %>）：

        <% if creds_by_id[cid] %>
          <span style="color: green;">認証済</span>
          <%= link_to "認証解除",
                "/redmine_freee_iv/auth/revoke?company_id=#{cid}",
                method: :delete,
                data: { confirm: "この事業所の認証を解除しますか？" } %>
        <% else %>
          <span style="color: red;">未認証</span>
          <%= link_to "認証する",
                "/redmine_freee_iv/auth/start?company_id=#{cid}" %>
        <% end %>
      </p>
    <% end %>

  <% end %>

<% end %>
<hr>

<!-- ========================================================= -->
<!--  見積書（QUOTATION） -->
<!-- ========================================================= -->

<h3>📄 見積書設定 </h3>

<p>
  <label>
    <%= check_box_tag 'settings[sync_quotations]', '1',
          settings['sync_quotations'] == '1',
          id: 'sync_quotations' %>
    見積書を同期する
  </label>
</p>

<div id="quotation_settings" style="display: none;">
  <p>
    チケット番号の抽出元：
    <select name="settings[ticket_source_quotation]">
      <option value="subject" <%= "selected" if settings['ticket_source_quotation'] == "subject" %>>
        件名 (subject)
      </option>
      <option value="quotation_number" <%= "selected" if settings['ticket_source_quotation'] == "quotation_number" %>>
        見積書番号 (quotation_number)
      </option>
    </select>
  </p>
  <p>
    見積書が <strong>送付済み (sent)</strong> の時のステータス：
    <%= select_tag 'settings[quotation_sent_status]',
          options_for_select(
            [["変更しない", 0]] + IssueStatus.all.map { |s| [s.name, s.id] },
            selected: settings['quotation_sent_status'].to_i
          )
    %>
    <label id="quotation_sent_label">見積書（送付済）のコメントテンプレート：</label><br>
    <textarea id="quotation_sent_comment" name="settings[quotation_sent_comment]" rows="3" style="width: 98%;"><%= settings['quotation_sent_comment'] %></textarea>
  </p>

  <p>
    見積書が <strong>未送付 (unsent)</strong> の時のステータス：
    <%= select_tag 'settings[quotation_unsent_status]',
          options_for_select(
            [["変更しない", 0]] + IssueStatus.all.map { |s| [s.name, s.id] },
            selected: settings['quotation_unsent_status'].to_i
          )
    %>
    <label id="quotation_unsent_label">見積書（未送付）のコメントテンプレート：</label><br>
    <textarea id="quotation_unsent_comment" name="settings[quotation_unsent_comment]" rows="3" style="width: 98%;"><%= settings['quotation_unsent_comment'] %></textarea>
  </p>
</div>

<hr>

<!-- ========================================================= -->
<!--  請求書（INVOICE） -->
<!-- ========================================================= -->

<h3>🧾 請求書設定</h3>

<p>
  <label>
    <%= check_box_tag 'settings[sync_invoices]', '1',
          settings['sync_invoices'] == '1',
          id: 'sync_invoices' %>
    請求書を同期する
  </label>
</p>

<div id="invoice_settings" style="display: none;">
  <p>
    チケット番号の抽出元：
    <select name="settings[ticket_source_invoice]">
      <option value="subject" <%= "selected" if settings['ticket_source_invoice'] == "subject" %>>
        件名 (subject)
      </option>
      <option value="invoice_number" <%= "selected" if settings['ticket_source_invoice'] == "invoice_number" %>>
        請求書番号 (invoice_number)
      </option>
    </select>
  </p>
<p>
  請求書が <strong>送付済み (sent)</strong> の時のステータス：
  <%= select_tag 'settings[invoice_sent_status]',
        options_for_select(
          [["変更しない", 0]] + IssueStatus.all.map { |s| [s.name, s.id] },
          selected: settings['invoice_sent_status'].to_i
        )
  %>
  <label id="invoice_sent_label">請求書（送付済）のコメントテンプレート：</label><br>
  <textarea id="invoice_sent_comment" name="settings[invoice_sent_comment]" rows="3" style="width: 98%;"><%= settings['invoice_sent_comment'] %></textarea>
</p>

<p>
  請求書が <strong>未送付 (unsent)</strong> の時のステータス：
  <%= select_tag 'settings[invoice_unsent_status]',
        options_for_select(
          [["変更しない", 0]] + IssueStatus.all.map { |s| [s.name, s.id] },
          selected: settings['invoice_unsent_status'].to_i
        )
  %>
  <label id="invoice_unsent_label">請求書（未送付）のコメントテンプレート：</label><br>
  <textarea id="invoice_unsent_comment" name="settings[invoice_unsent_comment]" rows="3" style="width: 98%;"><%= settings['invoice_unsent_comment'] %></textarea>
</p>

<p>
  請求書が <strong>入金済み (settled)</strong> の時のステータス：
  <%= select_tag 'settings[invoice_paid_status]',
        options_for_select(
          [["変更しない", 0]] + IssueStatus.all.map { |s| [s.name, s.id] },
          selected: settings['invoice_paid_status'].to_i
        )
  %>
  <label id="invoice_paid_label">請求書（入金済み）のコメントテンプレート：</label><br>
  <textarea id="invoice_paid_comment" name="settings[invoice_paid_comment]" rows="3" style="width: 98%;"><%= settings['invoice_paid_comment'] %></textarea>
  請求書が <strong>入金待ち (unsettled)</strong> の時のステータス：
  <%= select_tag 'settings[invoice_unpaid_status]',
        options_for_select(
          [["変更しない", 0]] + IssueStatus.all.map { |s| [s.name, s.id] },
          selected: settings['invoice_unpaid_status'].to_i
        )
  %>
  <label id="invoice_unpaid_label">請求書（入金待ち）のコメントテンプレート：</label><br>
  <textarea id="invoice_unpaid_comment" name="settingss[invoice_unpaid_comment]" rows="3" style="width: 98%;"><%= settings['invoice_unpaid_comment'] %></textarea>
</p>
</div>

<hr>

<!-- ========================================================= -->
<!--  納品書（DELIVERY） -->
<!-- ========================================================= -->

<h3>🧾 納品書設定</h3>

<p>
  <label>
    <%= check_box_tag 'settings[sync_delivery_slips]', '1',
          settings['sync_delivery_slips'] == '1',
          id: 'sync_delivery_slips' %>
    納品書を同期する
  </label>
</p>

<div id="delivery_settings" style="display: none;">
<p>
  チケット番号の抽出元：
  <select name="settings[ticket_source_delivery]">
    <option value="subject" <%= "selected" if settings['ticket_source_delivery'] == "subject" %>>
      件名 (subject)
    </option>
    <option value="delivery_slip_number" <%= "selected" if settings['ticket_source_delivery'] == "delivery_slip_number" %>>
      納品書番号 (delivery_slip_number)
    </option>
  </select>
</p>
  <p>
    納品書が <strong>送付済み (sent)</strong> の時のステータス：
    <%= select_tag 'settings[delivery_slip_sent_status]',
          options_for_select(
            [["変更しない", 0]] + IssueStatus.all.map { |s| [s.name, s.id] },
            selected: settings['delivery_slip_sent_status'].to_i
          )
    %>
    <label id="delivery_slip_sent_label">納品書（送付済）のコメントテンプレート：</label><br>
    <textarea id="delivery_slip_sent_comment" name="settings[delivery_slip_sent_comment]" rows="3" style="width: 98%;"><%= settings['delivery_slip_sent_comment'] %></textarea>
  </p>

  <p>
    納品書が <strong>未送付 (unsent)</strong> の時のステータス：
    <%= select_tag 'settings[delivery_slip_unsent_status]',
          options_for_select(
            [["変更しない", 0]] + IssueStatus.all.map { |s| [s.name, s.id] },
            selected: settings['delivery_slip_unsent_status'].to_i
          )
    %>
    <label id="delivery_slip_unsent_label">納品書（未送付）のコメントテンプレート：</label><br>
    <textarea id="delivery_slip_unsent_comment" name="settings[delivery_slip_unsent_comment]" rows="3" style="width: 98%;"><%= settings['delivery_slip_unsent_comment'] %></textarea>
  </p>

  <p>
    納品書が <strong>入金済み (settled)</strong> の時のステータス：
    <%= select_tag 'settings[delivery_slip_paid_status]',
          options_for_select(
            [["変更しない", 0]] + IssueStatus.all.map { |s| [s.name, s.id] },
            selected: settings['delivery_slip_paid_status'].to_i
          )
    %>
    <label id="delivery_slip_paid_label">納品書（入金済み）のコメントテンプレート：</label><br>
    <textarea id="delivery_slip_paid_comment" name="settings[delivery_slip_paid_comment]" rows="3" style="width: 98%;"><%= settings['delivery_slip_paid_comment'] %></textarea>
    納品書が <strong>入金待ち (unsettled)</strong> の時のステータス：
    <%= select_tag 'settings[delivery_slip_unpaid_status]',
          options_for_select(
            [["変更しない", 0]] + IssueStatus.all.map { |s| [s.name, s.id] },
            selected: settings['delivery_slip_unpaid_status'].to_i
          )
    %>
    <label id="delivery_slip_unpaid_label">納品書（入金待ち）のコメントテンプレート：</label><br>
    <textarea id="delivery_slip_unpaid_comment" name="settings[delivery_slip_unpaid_comment]" rows="3" style="width: 98%;"><%= settings['delivery_slip_unpaid_comment'] %></textarea>
  </p>
</div>

<hr>

<h3>🔄 同期ルール</h3>

<p>
  <label>
    <%= check_box_tag 'settings[apply_final_only]', '1',
          settings['apply_final_only'] == '1' %>
    最終ステータスのみに反映
  </label>
</p>

<p>
  見積書 → 請求書 → 納品書 の順にステータスを評価し、最終のステータスのみを適用します（推奨）
</p>

<hr>

<p>
  <label for="settings_ignored_status_ids">
    無視するステータス
  </label>
</p>

<%
  selected_ids = Array(settings['ignored_status_ids']).map(&:to_i)
%>

<p>
  <%= select_tag(
        'settings[ignored_status_ids][]',
        options_for_select(
          IssueStatus.all.map { |s| [s.name, s.id] },
          selected_ids
        ),
        multiple: true,
        size: 6,
        style: "width: 300px;"
      ) %>
</p>

<p>
  ここで選んだステータスのチケットは無視されます
</p>

<p>
  <label for="settings_max_fetch_total">最新からの最大取得件数</label>
  <% options = [
    [100],
    [200],
    [300],
    [400],
    [500],
    ['無制限', 'unlimited']
  ] %>

  <%= select_tag(
        'settings[max_fetch_total]',
        options_for_select(options, settings['max_fetch_total'] || 100)
      ) %>
</p>

<p>
  無制限を使うと freee API 使用制限にかかることがあります
  <a href="https://developer.freee.co.jp/reference/iv/reference#api_rate_limit"
     target="_blank" rel="noopener">
    freee API レートリミットについて
  </a>
</p>

<hr>

<p>
  <label for="settings_user_id">更新時に使用する Redmine ユーザー</label>
  <%= select_tag 'settings[user_id]',
        options_from_collection_for_select(
          User.active.order(:login), :id, :login, settings['user_id']
        )
  %>
</p>

<p>
  このユーザーとして Issue のコメントおよびステータス更新が実行されます。
</p>

<script>
$(function() {

  // ===========================
  //  同期チェックボックスの ON/OFF
  // ===========================

  function toggleBlock(check, block) {
    if ($(check).prop("checked")) {
      $(block).show();
    } else {
      $(block).hide();
    }
  }

  // 初期反映
  toggleBlock("#sync_quotations", "#quotation_settings");
  toggleBlock("#sync_invoices", "#invoice_settings");
  toggleBlock("#sync_delivery_slips", "#delivery_settings");

  // チェック変更時
  $("#sync_quotations").on("change", function() {
    toggleBlock("#sync_quotations", "#quotation_settings");
  });
  $("#sync_invoices").on("change", function() {
    toggleBlock("#sync_invoices", "#invoice_settings");
  });
  $("#sync_delivery_slips").on("change", function() {
    toggleBlock("#sync_delivery_slips", "#delivery_settings");
  });

  // ===========================
  //  「変更しない」選択時にコメントを非表示
  // ===========================

  const map = {
    "settings[quotation_sent_status]":     ["#quotation_sent_label", "#quotation_sent_comment"],
    "settings[quotation_unsent_status]":   ["#quotation_unsent_label", "#quotation_unsent_comment"],
    "settings[invoice_sent_status]":       ["#invoice_sent_label", "#invoice_sent_comment"],
    "settings[invoice_unsent_status]":     ["#invoice_unsent_label", "#invoice_unsent_comment"],
    "settings[invoice_paid_status]":       ["#invoice_paid_label", "#invoice_paid_comment"],
    "settings[invoice_unpaid_status]":     ["#invoice_unpaid_label", "#invoice_unpaid_comment"],
    "settings[delivery_slip_sent_status]": ["#delivery_slip_sent_label", "#delivery_slip_sent_comment"],
    "settings[delivery_slip_unsent_status]":["#delivery_slip_unsent_label", "#delivery_slip_unsent_comment"],
    "settings[delivery_slip_paid_status]": ["#delivery_slip_paid_label", "#delivery_slip_paid_comment"],
    "settings[delivery_slip_unpaid_status]":["#delivery_slip_unpaid_label", "#delivery_slip_unpaid_comment"]
  };

  function syncVisibility(selectEl) {
    const name = $(selectEl).attr("name");
    const pair = map[name];
    if (!pair) return;

    const show = $(selectEl).val() !== "0";

    pair.forEach(id => {
      if (show) $(id).show();
      else      $(id).hide();
    });
  }

  // 初期化（各 select に対して実行）
  Object.keys(map).forEach(name => {
    syncVisibility($(`select[name="${name}"]`));
  });

  // select の変更イベント
  $(document).on("change", "select", function() {
    syncVisibility(this);
  });

});
</script>
