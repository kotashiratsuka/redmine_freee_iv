<% creds = FreeeIvCredential.all %>
<% authed_count = creds.size %>

<h3>認証設定</h3>

<% if authed_count == 0 %>

  <p>Client ID / Secret を入力、保存してから認証を開始してください</p>

  <p>
    <label>Client ID</label>
    <input type="text" name="settings[client_id]" value="<%= settings['client_id'] %>" />
  </p>

  <p>
    <label>Client Secret</label>
    <input type="password" name="settings[client_secret]" value="<%= settings['client_secret'] %>" />
  </p>

  <p><input type="submit" value="保存" class="button-small"></p>

  <% if settings['client_id'].present? && settings['client_secret'].present? %>
    <p><%= link_to "▶ 認証を開始する", "/redmine_freee_iv/auth/start" %></p>
  <% end %>

<% else %>

  <%
    begin
      comps = FreeeApiClient.companies
      api_status  = :ok
      api_message = "#{comps.size} 件の事業所を取得しました"
    rescue => e
      comps = []
      api_status  = :error
      api_message = "APIエラー: #{e.message}"
    end

    creds_by_id = FreeeIvCredential.all.index_by(&:company_id)
  %>

  <%# ================================
     API成功 && comps=0 → token破損扱い
     ================================ %>
  <% if api_status == :ok && comps.size == 0 %>

    <p style="color:red; font-weight:bold;">
      事業所が取得できません。再認証が必要です。
    </p>

    <% if settings['client_id'].present? && settings['client_secret'].present? %>
      <p>
        <%= link_to "▶ 再認証する", "/redmine_freee_iv/auth/start" %>
      </p>
    <% end %>

    <p style="margin-top: 1em;">
      <strong>既存の認証情報：</strong>
    </p>

    <% creds.each do |cred| %>
      <p style="margin-left: 1em;">
        <strong>事業所 ID: <%= cred.company_id %></strong>：
        <span style="color: orange;">認証エラー</span>
        <%= link_to "認証解除",
              "/redmine_freee_iv/auth/revoke?company_id=#{cred.company_id}",
              method: :delete,
              data: { confirm: "この事業所の認証を解除しますか？" } %>
      </p>
    <% end %>

  <% elsif api_status == :error %>

    <p><strong>freee API 接続テスト：</strong>
      <span style="color: red;">● エラー</span>（<%= api_message %>）
    </p>

    <% if settings['client_id'].present? && settings['client_secret'].present? %>
      <p><%= link_to "▶ 再認証する", "/redmine_freee_iv/auth/start" %></p>
    <% end %>

    <p style="margin-top: 1em;">
      <strong>既存の認証情報：</strong>
    </p>

    <% creds.each do |cred| %>
      <p style="margin-left: 1em;">
        <strong>事業所 ID: <%= cred.company_id %></strong>：
        <span style="color: orange;">認証エラー</span>
        <%= link_to "認証解除",
              "/redmine_freee_iv/auth/revoke?company_id=#{cred.company_id}",
              method: :delete,
              data: { confirm: "この事業所の認証を解除しますか？" } %>
      </p>
    <% end %>

  <% else %>

    <p>
      <strong>認証済事業所数：</strong>
      <%= creds_by_id.size %> / <%= comps.size %>
    </p>

    <p><strong>freee API 接続テスト：</strong>
      <span style="color: green;">● OK</span>（<%= api_message %>）
    </p>

    <% comps.each do |c| %>
      <% cid = c["id"].to_s %>
      <p style="margin-left: 1em;">
        <strong><%= c["display_name"] %></strong>（ID: <%= cid %>）：

        <% if creds_by_id[cid] %>
          <span style="color: green;">認証済</span>
          <%= link_to "認証解除",
                "/redmine_freee_iv/auth/revoke?company_id=#{cid}",
                method: :delete,
                data: { confirm: "この事業所の認証を解除しますか？" } %>
        <% else %>
          <span style="color: red;">未認証</span>
          <%= link_to "認証する",
                "/redmine_freee_iv/auth/start?company_id=#{cid}" %>
        <% end %>
      </p>
    <% end %>

  <% end %>

<% end %>
<hr>

<%
  document_types = DocumentTypeDefinitions.document_types
  status_options = [["変更しない", 0]] + IssueStatus.all.map { |s| [s.name, s.id] }
%>

<% document_types.each do |_type, defn| %>
  <h3><%= defn[:emoji] %> <%= defn[:label] %>設定</h3>

  <p>
    <label>
      <%= check_box_tag "settings[#{defn[:sync_key]}]", '1',
            settings[defn[:sync_key]] == '1',
            id: defn[:sync_checkbox_id] %>
      <%= defn[:label] %>を同期する
    </label>
  </p>

  <div id="<%= defn[:settings_block_id] %>" style="display: none;">
    <p>
      チケット番号の抽出元：
      <select name="settings[<%= defn[:ticket_source_key] %>]">
        <% defn[:ticket_sources].each do |value, label| %>
          <option value="<%= value %>" <%= "selected" if settings[defn[:ticket_source_key]] == value %>>
            <%= label %>
          </option>
        <% end %>
      </select>
    </p>

    <% defn[:statuses].each do |status| %>
      <% status_label = DocumentTypeDefinitions.status_label(status) %>
      <% short_label = DocumentTypeDefinitions.status_short_label(status) %>
      <% status_key = "#{defn[:settings_prefix]}_#{status}_status" %>
      <% comment_key = "#{defn[:settings_prefix]}_#{status}_comment" %>
      <% label_id = "#{defn[:settings_prefix]}_#{status}_label" %>
      <p>
        <%= defn[:label] %>が <strong><%= status_label %></strong> の時のステータス：
        <%= select_tag "settings[#{status_key}]",
              options_for_select(status_options, selected: settings[status_key].to_i)
        %>
        <label id="<%= label_id %>"><%= defn[:label] %>（<%= short_label %>）のコメントテンプレート：</label><br>
        <textarea id="<%= comment_key %>" name="settings[<%= comment_key %>]" rows="3" style="width: 98%;"><%= settings[comment_key] %></textarea>
      </p>
    <% end %>
  </div>

  <hr>
<% end %>

<h3>🔄 同期ルール</h3>

<p>
  <label>
    <%= check_box_tag 'settings[apply_final_only]', '1',
          settings['apply_final_only'] == '1' %>
    最終ステータスのみに反映
  </label>
</p>

<p>
  見積書 → 請求書 → 納品書 の順にステータスを評価し、最終のステータスのみを適用します（推奨）
</p>

<hr>

<p>
  <label for="settings_ignored_status_ids">
    無視するステータス
  </label>
</p>

<%
  selected_ids = Array(settings['ignored_status_ids']).map(&:to_i)
%>

<p>
  <%= select_tag(
        'settings[ignored_status_ids][]',
        options_for_select(
          IssueStatus.all.map { |s| [s.name, s.id] },
          selected_ids
        ),
        multiple: true,
        size: 6,
        style: "width: 300px;"
      ) %>
</p>

<p>
  ここで選んだステータスのチケットは無視されます
</p>

<p>
  <label for="settings_max_fetch_total">最新からの最大取得件数</label>
  <% options = [
    [100],
    [200],
    [300],
    [400],
    [500],
    ['無制限', 'unlimited']
  ] %>

  <%= select_tag(
        'settings[max_fetch_total]',
        options_for_select(options, settings['max_fetch_total'] || 100)
      ) %>
</p>

<p>
  無制限を使うと freee API 使用制限にかかることがあります
  <a href="https://developer.freee.co.jp/reference/iv/reference#api_rate_limit"
     target="_blank" rel="noopener">
    freee API レートリミットについて
  </a>
</p>

<hr>

<p>
  <label for="settings_user_id">更新時に使用する Redmine ユーザー</label>
  <%= select_tag 'settings[user_id]',
        options_from_collection_for_select(
          User.active.order(:login), :id, :login, settings['user_id']
        )
  %>
</p>

<p>
  このユーザーとして Issue のコメントおよびステータス更新が実行されます。
</p>

<%
  toggle_pairs = document_types.map do |_, defn|
    [defn[:sync_checkbox_id], defn[:settings_block_id]]
  end

  comment_map_entries = document_types.flat_map do |_, defn|
    defn[:statuses].map do |status|
      status_key = "#{defn[:settings_prefix]}_#{status}_status"
      label_id = "#{defn[:settings_prefix]}_#{status}_label"
      comment_id = "#{defn[:settings_prefix]}_#{status}_comment"
      [status_key, label_id, comment_id]
    end
  end
%>

<script>
$(function() {

  // ===========================
  //  同期チェックボックスの ON/OFF
  // ===========================

  function toggleBlock(check, block) {
    if ($(check).prop("checked")) {
      $(block).show();
    } else {
      $(block).hide();
    }
  }

  // 初期反映
  <% toggle_pairs.each do |check_id, block_id| %>
    toggleBlock("#<%= check_id %>", "#<%= block_id %>");
  <% end %>

  // チェック変更時
  <% toggle_pairs.each do |check_id, block_id| %>
    $("#<%= check_id %>").on("change", function() {
      toggleBlock("#<%= check_id %>", "#<%= block_id %>");
    });
  <% end %>

  // ===========================
  //  「変更しない」選択時にコメントを非表示
  // ===========================

  const map = {
    <% comment_map_entries.each_with_index do |(status_key, label_id, comment_id), index| %>
      "settings[<%= status_key %>]": ["#<%= label_id %>", "#<%= comment_id %>"]<%= "," if index < comment_map_entries.size - 1 %>
    <% end %>
  };

  function syncVisibility(selectEl) {
    const name = $(selectEl).attr("name");
    const pair = map[name];
    if (!pair) return;

    const show = $(selectEl).val() !== "0";

    pair.forEach(id => {
      if (show) $(id).show();
      else      $(id).hide();
    });
  }

  // 初期化（各 select に対して実行）
  Object.keys(map).forEach(name => {
    syncVisibility($(`select[name="${name}"]`));
  });

  // select の変更イベント
  $(document).on("change", "select", function() {
    syncVisibility(this);
  });

});
</script>
